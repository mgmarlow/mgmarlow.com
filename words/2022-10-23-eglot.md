---
title: Eglot and LSP in Emacs 29
date: 2022-10-29
tags: emacs
---

[Eglot](https://joaotavora.github.io/eglot/), an Emacs package that integrates the [language server protocol](https://microsoft.github.io/language-server-protocol/) (LSP) into Emacs, was just merged into [Emacs main](https://lists.gnu.org/archive/html/emacs-devel/2022-10/msg01609.html). Congratulations to João Távora!

LSP was originally designed to provide IDE language features to Visual Studio Code, i.e., "Go to definition" or "Find references". The project was later open sourced by Microsoft and integrated into Visual Studio.

The protocol came out of the need to design an editor-specific compiler that prioritizes the sorts of features programmers care about when writing code. While such a compiler can be built on an ad-hoc basis for a certain programming language and IDE combo, it becomes difficult to integrate into editors that are built with some other programming language. With LSP, the compiler is run in an [independent process](https://learn.microsoft.com/en-us/visualstudio/extensibility/language-server-protocol?view=vs-2022#how-the-lsp-works) that communicates to the editor via messages, serialized as JSON.

Decoupling the language server implementation from the editor or extension implementation is a great move that has seen a [broad level of adoption](https://langserver.org/#implementations-server) in the editor space, even outside of Visual Studio Code. And now with Emacs 29, we have support built into Emacs.

However, as with anything Emacs, there is more than one choice of package for LSP support. Why was Eglot merged over the alternatives? Two primary reasons come to mind:

1. Free Software Foundation (FSF) licensing
2. Ability to follow idiomatic Emacs conventions

GNU requires that "[legally significant](https://www.gnu.org/prep/maintain/html_node/Legally-Significant.html#Legally-Significant)" contributions are accompanied by signed paperwork, namely that the [FSF maintains the legal right](https://www.gnu.org/prep/maintain/html_node/Copyright-Papers.html#Copyright-Papers) to distribute the package. The nature of this requirement is fundamental to Emacs merge acceptance. Without requiring every "legally significant" contributor to sign the appropriate paperwork for their contribution, the package can never be merged into Emacs main (see [use-package#282](https://github.com/jwiegley/use-package/issues/282) as an example).

Another consideration for package integration is its adherence to the idioms of the Emacs ecosystem. How well does the package integrate with existing Emacs tools and conventions? In eglot's case, there are a lot of positives:

- No dependencies outside of Emacs
- Integrates well with [Flymake](https://www.gnu.org/software/emacs/manual/html_mono/flymake.html#Top), [Xref](https://www.gnu.org/software/emacs/manual/html_mono/emacs.html#Xref), [Imenu](https://www.gnu.org/software/emacs/manual/html_mono/emacs.html#Imenu), and [Eldoc](https://www.gnu.org/software/emacs/manual/html_mono/emacs.html#Lisp-Doc)
- Works out of the box without additional configuration

Here's my eglot configuration for TypeScript, React, and web-mode (note that typescript-mode is supported without any extra config):

```
(use-package eglot
  :hook ((web-mode . eglot-ensure))
  :config
  (add-to-list 'eglot-server-programs
               '(web-mode . ("typescript-language-server" "--stdio"))))
```

## What about alternatives?

The alternative I have the most experience with is [lsp-mode](https://github.com/emacs-lsp/lsp-mode), which I used for six or so months before switching to eglot. Unlike eglot, lsp-mode has [no intention of being merged into Emacs main](https://github.com/emacs-lsp/lsp-mode/issues/444), allowing it some more flexibility in its design and implementation.

Overall, lsp-mode is more of a maximal package. It has a ton of features, including bespoke [UI implementations](https://emacs-lsp.github.io/lsp-ui), non-ELPA package integrations like [dap-mode](https://github.com/emacs-lsp/dap-mode) and [dash](https://github.com/magnars/dash.el), and support for [multiple language servers](https://github.com/emacs-lsp/lsp-mode/issues/424) for a single file. The overall philosophy behind lsp-mode is drastically different from eglot, and that reflects in usability of the package.

Whether you pick one over the other is probably down to your reaction to [lsp-ui](https://emacs-lsp.github.io/lsp-ui/). If it sparks joy, lsp-mode will serve you well. Otherwise, you're better off giving eglot a try.

No matter which LSP package you pick, it's worth reading through lsp-mode's [performance documentation](https://emacs-lsp.github.io/lsp-mode/page/performance/). The advice within is beneficial for both packages.

Here's my lsp-mode (with lsp-ui) configuration for TypeScript, React, and web-mode:

```
(use-package lsp-mode
  :ensure t
  :init
  (setq lsp-keymap-prefix "C-c l")
  :hook ((web-mode . lsp))
  :commands lsp)
```

## tl;dr

Eglot is a rad LSP package that is now merged into Emacs main, staged for release with Emacs 29. It's well worth giving it a try, even if you already use lsp-mode. You may prefer its comparatively lightweight feel.

### eglot

- Minimalist implementation that "just works"
- Available out of the box with Emacs 29
- Development may slow down since it's now integrated in Emacs main
- No dependencies outside of Emacs

### lsp-mode

- Optional UI extras with [lsp-ui](https://emacs-lsp.github.io/lsp-ui)
- Debugging support with [dap-mode](https://emacs-lsp.github.io/dap-mode/)
- Support for [Flycheck](https://github.com/flycheck/flycheck), a Flymake alternative
- Can be a pain to get set up (mine didn't work until I thoroughly implemented the [performance guidance](https://emacs-lsp.github.io/lsp-mode/page/performance/))
